name: Fly Deploy
on:
  push:                     # run on every push to any branch
env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3          # v3 is current

      - uses: superfly/flyctl-actions/setup-flyctl@master

      # ---------- Create volume if it isn't there ----------
      - name: Ensure 'data' volume exists
        run: |
          # flyctl exits 0 if the volume already exists
          flyctl volumes create data --region dfw --size 1 --if-not-exists
      # -----------------------------------------------------

      # ---------- Deploy the app ----------
      - name: Deploy to Fly
        run: flyctl deploy --remote-only
      # ------------------------------------

      # ---------- Friendly log ----------
      - name: Show mount hint (first run only)
        if: ${{ github.run_attempt == 1 }}
        run: |
          echo "::notice::Add this to fly.toml if you haven't yet:"
          echo "[[mounts]]"
          echo "  source      = \"data\""
          echo "  destination = \"/home/node/.n8n\""
