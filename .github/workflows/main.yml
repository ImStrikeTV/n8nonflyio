name: Fly Deploy
on: [push]

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

jobs:
  deploy:
    name: Deploy app
    runs-on: ubuntu-latest
    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1. Check out repo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: actions/checkout@v2

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2. Install flyctl  â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: superfly/flyctl-actions/setup-flyctl@master

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3. Ensure volume exists â”€â”€â”€â”€
      # (--if-exists returns 0 if it's already there, so the job never fails)
      - name: Ensure persistent volume
        run: |
          flyctl volumes create data \
            --region dfw \
            --size 1 \
            --if-exists       # ğŸ‘ˆ  prevents â€œalready existsâ€ error

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4. Deploy exactly as before â”€
      - name: Deploy to Fly
        run: flyctl deploy --remote-only
